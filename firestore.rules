// Firestore security rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -----------------------
    // Helpers
    // -----------------------
    function isAuthed() { return request.auth != null; }
    function userDoc() { return get(/databases/$(database)/documents/users/$(request.auth.uid)); }
    function currentUserData() { return userDoc().data; }

    function roleMatches(target, pattern) {
      return target is string && target.matches(pattern);
    }

    function isAdmin() {
      return isAuthed()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && roleMatches(userDoc().data.role, '(?i)^admin$');
    }

    function isOwner() {
      return isAuthed()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && (
          roleMatches(userDoc().data.role, '(?i)^owner$') ||
          userDoc().data.role == true
        );
    }

    function approvedIsTrue() {
      return currentUserData().keys().hasAny(['approved'])
        && (
          currentUserData().approved == true
          || currentUserData().approved == 'true'
          || currentUserData().approved == 1
        );
    }

    function notDisabledTrue() {
      return !currentUserData().keys().hasAny(['disabled'])
        || (
          currentUserData().disabled != true
          && currentUserData().disabled != 'true'
          && currentUserData().disabled != 1
        );
    }

    function canReadRides() {
      return isAuthed()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && approvedIsTrue()
        && notDisabledTrue();
    }

    function isActiveUser() {
      return canReadRides();
    }

    function has(k) { return request.resource.data.keys().hasAny([k]); }

    function validExpoPushTokens(val) {
      return val is list
        && val.size() <= 5
        && (val.size() == 0 || (val[0] is string && val[0].size() > 0 && val[0].size() <= 255))
        && (val.size() < 2 || (val[1] is string && val[1].size() > 0 && val[1].size() <= 255))
        && (val.size() < 3 || (val[2] is string && val[2].size() > 0 && val[2].size() <= 255))
        && (val.size() < 4 || (val[3] is string && val[3].size() > 0 && val[3].size() <= 255))
        && (val.size() < 5 || (val[4] is string && val[4].size() > 0 && val[4].size() <= 255));
    }

    function roleIsOneOf(target) {
      return target == null
        || roleMatches(target, '(?i)^member$')
        || roleMatches(target, '(?i)^admin$')
        || roleMatches(target, '(?i)^owner$');
    }


    function isSelfOrOwner(targetUid) {
      return isAuthed() && (request.auth.uid == targetUid || isOwner());
    }

    // --- SHARED VAL (Rides/Treks) ---

    function rideAllowedKeys() {
      return [
        'title','meetingPoint','description','bikes',
        'date','dateTime',
        'maxParticipants','participantsCount','participantsCountSelf','participantsCountTotal',
        'createdBy','createdAt','updatedBy','updatedAt',
        'status','archived','archiveYear','archiveMonth',
        'guidaName','guidaNames','link','difficulty',
        'guidaName','guidaNames','link','difficulty',
        'manualParticipants','extraServices','serviceStats',
        'kind','trek'
      ];
    }

    function validServiceResponses(val) {
      return val == null ||
        (
          val is map &&
          val.keys().hasOnly(['lunch','dinner','overnight']) &&
          (!val.keys().hasAny(['lunch']) || val.lunch == null || (val.lunch == 'yes' || val.lunch == 'no')) &&
          (!val.keys().hasAny(['dinner']) || val.dinner == null || (val.dinner == 'yes' || val.dinner == 'no')) &&
          (!val.keys().hasAny(['overnight']) || val.overnight == null || (val.overnight == 'yes' || val.overnight == 'no'))
        );
    }

    function validExtraServices(val) {
      return val == null ||
        (
          val is map &&
          val.keys().hasOnly(['lunch','dinner','overnight']) &&
          (!val.keys().hasAny(['lunch']) || validExtraNode(val.lunch)) &&
          (!val.keys().hasAny(['dinner']) || validExtraNode(val.dinner)) &&
          (!val.keys().hasAny(['overnight']) || validExtraNode(val.overnight))
        );
    }

    function validExtraNode(node) {
      return node == null ||
        (
          node is map &&
          node.keys().hasOnly(['enabled','label']) &&
          node.enabled is bool &&
          (!node.keys().hasAny(['label']) || node.label == null || (node.label is string && node.label.size() <= 120))
        );
    }

    function validServiceStats(val) {
      return val == null ||
        (
          val is map &&
          val.keys().hasOnly(['lunch','dinner','overnight']) &&
          (!val.keys().hasAny(['lunch']) || validStatsNode(val.lunch)) &&
          (!val.keys().hasAny(['dinner']) || validStatsNode(val.dinner)) &&
          (!val.keys().hasAny(['overnight']) || validStatsNode(val.overnight))
        );
    }

    function validStatsNode(node) {
      return node == null ||
        (
          node is map &&
          node.keys().hasOnly(['yes','no']) &&
          (!node.keys().hasAny(['yes']) || (node.yes is int && node.yes >= 0)) &&
          (!node.keys().hasAny(['no']) || (node.no is int && node.no >= 0))
        );
    }

    function validManualParticipants(val) {
      return val == null || (val is list && val.size() <= 50);
    }

    function validRideCreateFlexible() {
      return request.resource.data.keys().hasOnly(rideAllowedKeys())
        && has('title') && request.resource.data.title is string && request.resource.data.title.size() > 0 && request.resource.data.title.size() <= 120
        && has('meetingPoint') && request.resource.data.meetingPoint is string && request.resource.data.meetingPoint.size() > 0 && request.resource.data.meetingPoint.size() <= 200
        && ((has('dateTime') && request.resource.data.dateTime is timestamp) || (has('date') && request.resource.data.date is timestamp))
        && has('createdBy') && request.resource.data.createdBy is string && request.resource.data.createdBy.size() > 0
        && has('createdAt') && request.resource.data.createdAt is timestamp
        && (!has('description') || request.resource.data.description == null || request.resource.data.description is string)
        && (!has('bikes') || request.resource.data.bikes == null || (request.resource.data.bikes is list && request.resource.data.bikes.size() <= 20))
        && (!has('date') || request.resource.data.date == null || request.resource.data.date is timestamp)
        && (!has('maxParticipants') || request.resource.data.maxParticipants == null || (request.resource.data.maxParticipants is int && request.resource.data.maxParticipants >= 0))
        && (!has('participantsCount') || (request.resource.data.participantsCount is int && request.resource.data.participantsCount >= 0))
        && (!has('participantsCountSelf') && !has('participantsCountTotal'))
        && (!has('status') || (request.resource.data.status == 'active' || request.resource.data.status == 'cancelled'))
        && (!has('archived') || request.resource.data.archived is bool)
        && (!has('archiveYear') || request.resource.data.archiveYear == null || request.resource.data.archiveYear is int)
        && (!has('archiveMonth') || request.resource.data.archiveMonth == null || (request.resource.data.archiveMonth is int && request.resource.data.archiveMonth >= 1 && request.resource.data.archiveMonth <= 12))
        && (!has('guidaName') || request.resource.data.guidaName == null || request.resource.data.guidaName is string)
        && (!has('guidaNames') || request.resource.data.guidaNames == null || request.resource.data.guidaNames is list)
        && (!has('link') || request.resource.data.link == null || request.resource.data.link is string)
        && (!has('difficulty') || request.resource.data.difficulty == null || request.resource.data.difficulty is string)
        && (!has('manualParticipants') || validManualParticipants(request.resource.data.manualParticipants))
        && (!has('extraServices') || validExtraServices(request.resource.data.extraServices))
        && (!has('updatedAt') || request.resource.data.updatedAt is timestamp || request.resource.data.updatedAt == request.time)
        && (!has('updatedBy') || request.resource.data.updatedBy == null || request.resource.data.updatedBy is string)
        && (!has('serviceStats') || validServiceStats(request.resource.data.serviceStats));
    }

    function validRideUpdatePartial() {
      let diff = request.resource.data.diff(resource.data);
      let changed = diff.changedKeys();
      let added   = diff.addedKeys();
      let removed = diff.removedKeys();

      return changed.union(added).union(removed).hasOnly(rideAllowedKeys())
        && (!(changed.hasAny(['title']) || added.hasAny(['title'])) || (request.resource.data.title is string && request.resource.data.title.size() > 0 && request.resource.data.title.size() <= 120))
        && (!(changed.hasAny(['meetingPoint']) || added.hasAny(['meetingPoint'])) || (request.resource.data.meetingPoint is string && request.resource.data.meetingPoint.size() > 0 && request.resource.data.meetingPoint.size() <= 200))
        && (!(changed.hasAny(['description']) || added.hasAny(['description'])) || (request.resource.data.description == null || request.resource.data.description is string))
        && (!(changed.hasAny(['bikes']) || added.hasAny(['bikes'])) || (request.resource.data.bikes == null || (request.resource.data.bikes is list && request.resource.data.bikes.size() <= 20)))
        && (!(changed.hasAny(['dateTime']) || added.hasAny(['dateTime'])) || request.resource.data.dateTime is timestamp)
        && (!(changed.hasAny(['date']) || added.hasAny(['date'])) || (request.resource.data.date == null || request.resource.data.date is timestamp))
        && (!(changed.hasAny(['maxParticipants']) || added.hasAny(['maxParticipants'])) || (request.resource.data.maxParticipants == null || (request.resource.data.maxParticipants is int && request.resource.data.maxParticipants >= 0)))
        && (!(changed.hasAny(['participantsCount']) || added.hasAny(['participantsCount'])) || (request.resource.data.participantsCount is int && request.resource.data.participantsCount >= 0))
        && !(changed.hasAny(['participantsCountSelf','participantsCountTotal']) || added.hasAny(['participantsCountSelf','participantsCountTotal']))
        && (!(changed.hasAny(['status']) || added.hasAny(['status'])) || (request.resource.data.status == 'active' || request.resource.data.status == 'cancelled'))
        && (!(changed.hasAny(['archived']) || added.hasAny(['archived'])) || request.resource.data.archived is bool)
        && (!(changed.hasAny(['archiveYear']) || added.hasAny(['archiveYear'])) || (request.resource.data.archiveYear == null || request.resource.data.archiveYear is int))
        && (!(changed.hasAny(['archiveMonth']) || added.hasAny(['archiveMonth'])) || (request.resource.data.archiveMonth == null || (request.resource.data.archiveMonth is int && request.resource.data.archiveMonth >= 1 && request.resource.data.archiveMonth <= 12)))
        && (!(changed.hasAny(['createdBy']) || added.hasAny(['createdBy'])) || request.resource.data.createdBy is string)
        && (!(changed.hasAny(['createdAt']) || added.hasAny(['createdAt'])) || request.resource.data.createdAt is timestamp)
        && (!(changed.hasAny(['updatedAt']) || added.hasAny(['updatedAt'])) || request.resource.data.updatedAt is timestamp || request.resource.data.updatedAt == request.time)
        && (!(changed.hasAny(['updatedBy']) || added.hasAny(['updatedBy'])) || request.resource.data.updatedBy == null || request.resource.data.updatedBy is string)
        && (!(changed.hasAny(['guidaName']) || added.hasAny(['guidaName'])) || (request.resource.data.guidaName == null || request.resource.data.guidaName is string))
        && (!(changed.hasAny(['guidaNames']) || added.hasAny(['guidaNames'])) || (request.resource.data.guidaNames == null || request.resource.data.guidaNames is list))
        && (!(changed.hasAny(['link']) || added.hasAny(['link'])) || (request.resource.data.link == null || request.resource.data.link is string))
        && (!(changed.hasAny(['difficulty']) || added.hasAny(['difficulty'])) || (request.resource.data.difficulty == null || request.resource.data.difficulty is string))
        && (!(changed.hasAny(['manualParticipants']) || added.hasAny(['manualParticipants'])) || validManualParticipants(request.resource.data.manualParticipants))
        && (!(changed.hasAny(['extraServices']) || added.hasAny(['extraServices'])) || validExtraServices(request.resource.data.extraServices))
        && (!(changed.hasAny(['serviceStats']) || added.hasAny(['serviceStats'])) || validServiceStats(request.resource.data.serviceStats));
    }

    // -----------------------
    // /users/{uid}
    // -----------------------
    match /users/{uid} {
      allow get:  if isAuthed() && (request.auth.uid == uid || isOwner());
      allow list: if isAuthed() && isOwner();

      allow create: if isAuthed() && request.auth.uid == uid && validUserCreateSelf();

      // Consente all'utente autenticato di aggiornare SOLO il proprio campo expoPushTokens
      allow update: if
        request.auth != null &&
        request.auth.uid == uid &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(["expoPushTokens"]) &&
        validExpoPushTokens(request.resource.data.expoPushTokens);

      allow update: if isAuthed() && (
        (isOwner() && validUserUpdateAdmin()) ||
        (request.auth.uid == uid && validUserUpdateSelf())
      );

      allow delete: if isAuthed() && isOwner() && validUserDelete();

      function isValidMembershipCard(val) {
        return val == null
          || (
            val is string &&
            val.size() > 0 &&
            val.size() <= 400000
          )
          || (
            val is map &&
            val.keys().hasOnly(['base64','updatedAt']) &&
            val.base64 is string &&
            val.base64.size() > 0 &&
            val.base64.size() <= 400000 &&
            (
              !val.keys().hasAny(['updatedAt']) ||
              (val.updatedAt is timestamp && val.updatedAt == request.time)
            )
          );
      }

      function allowedUserKeys() {
        return [
          'uid','email','displayName','firstName','lastName','nickname',
          'role','approved','disabled','createdAt','expoPushToken','membershipCard',
          'selfDeleted','selfDeletedAt',
          'enabledSections',
          // nuovi campi per le notifiche
          'notificationsDisabled',
          'notificationsDisabledForCreatedRide',
          'notificationsDisabledForCancelledRide',
          'notificationsDisabledForPendingUser',
          'notificationsDisabledForBoardPost'
        ];
      }

      // ---- enabledSections validation (Owner-only via validUserUpdateAdmin) ----
      function isAllowedSection(val) {
        return val is string
          && (val == 'ciclismo' || val == 'trekking' || val == 'bikeaut');
      }

      function validEnabledSections() {
        return !request.resource.data.keys().hasAny(['enabledSections'])
          || (
            request.resource.data.enabledSections is list
            && request.resource.data.enabledSections.size() <= 3
            && (
              request.resource.data.enabledSections.size() == 0
              || (
                isAllowedSection(request.resource.data.enabledSections[0])
                && (
                  request.resource.data.enabledSections.size() == 1
                  || (
                    isAllowedSection(request.resource.data.enabledSections[1])
                    && request.resource.data.enabledSections[1] != request.resource.data.enabledSections[0]
                    && (
                      request.resource.data.enabledSections.size() == 2
                      || (
                        isAllowedSection(request.resource.data.enabledSections[2])
                        && request.resource.data.enabledSections[2] != request.resource.data.enabledSections[0]
                        && request.resource.data.enabledSections[2] != request.resource.data.enabledSections[1]
                      )
                    )
                  )
                )
              )
            )
          );
      }

      function validUserCreateSelf() {
        return request.resource.data.keys().hasOnly(allowedUserKeys())
          && request.resource.data.uid == uid
          && request.resource.data.email is string
          && (request.resource.data.displayName is string || request.resource.data.displayName == null)
          && (request.resource.data.firstName is string || request.resource.data.firstName == null)
          && (request.resource.data.lastName is string || request.resource.data.lastName == null)
          && (request.resource.data.nickname is string || request.resource.data.nickname == null)
          && roleMatches(request.resource.data.role, '(?i)^member$')
          && request.resource.data.approved == false
          && (!has('disabled') || request.resource.data.disabled == false)
          && (request.resource.data.createdAt is timestamp || request.resource.data.createdAt == request.time)
          && request.resource.data.createdAt == request.time
          && (!has('membershipCard') || isValidMembershipCard(request.resource.data.membershipCard))
          && (!has('selfDeleted') || request.resource.data.selfDeleted == false)
          && (!has('selfDeletedAt') || request.resource.data.selfDeletedAt == null)
          && (!has('enabledSections'))
          // se presenti, i flag di notifica devono essere booleani
          && (!has('notificationsDisabled') || request.resource.data.notificationsDisabled is bool)
          && (!has('notificationsDisabledForCreatedRide') || request.resource.data.notificationsDisabledForCreatedRide is bool)
          && (!has('notificationsDisabledForCancelledRide') || request.resource.data.notificationsDisabledForCancelledRide is bool)
          && (!has('notificationsDisabledForPendingUser') || request.resource.data.notificationsDisabledForPendingUser is bool)
          && (!has('notificationsDisabledForBoardPost') || request.resource.data.notificationsDisabledForBoardPost is bool);
      }

      function validUserUpdateAdmin() {
        let diff    = request.resource.data.diff(resource.data);
        let changed = diff.changedKeys();
        let added   = diff.addedKeys();
        let removed = diff.removedKeys();

        return changed.union(added).union(removed).hasOnly(allowedUserKeys())
          && request.resource.data.uid == resource.data.uid
          && (!changed.hasAny(['email'])        || request.resource.data.email is string)
          && (!changed.hasAny(['displayName'])  || request.resource.data.displayName == null || request.resource.data.displayName is string)
          && (!changed.hasAny(['firstName'])    || request.resource.data.firstName == null   || request.resource.data.firstName is string)
          && (!changed.hasAny(['lastName'])     || request.resource.data.lastName == null    || request.resource.data.lastName is string)
          && (!changed.hasAny(['nickname'])     || request.resource.data.nickname == null    || request.resource.data.nickname is string)
          && (!changed.hasAny(['role'])         || roleIsOneOf(request.resource.data.role))
          && (!changed.hasAny(['approved'])     || request.resource.data.approved is bool)
          && (!changed.hasAny(['disabled'])     || request.resource.data.disabled is bool)
          && (!changed.hasAny(['createdAt'])    || request.resource.data.createdAt is timestamp)
          && (!changed.hasAny(['expoPushToken'])|| request.resource.data.expoPushToken == null || request.resource.data.expoPushToken is string)
          && (!changed.hasAny(['membershipCard']) || isValidMembershipCard(request.resource.data.membershipCard))
          && (!changed.hasAny(['selfDeleted'])   || request.resource.data.selfDeleted is bool)
          && (!changed.hasAny(['selfDeletedAt']) || request.resource.data.selfDeletedAt == null || request.resource.data.selfDeletedAt is timestamp)
          && (!changed.hasAny(['enabledSections']) || validEnabledSections())
          // nuovi flag notifica: se cambiano, devono essere bool
          && (!changed.hasAny(['notificationsDisabled']) || request.resource.data.notificationsDisabled is bool)
          && (!changed.hasAny(['notificationsDisabledForCreatedRide']) || request.resource.data.notificationsDisabledForCreatedRide is bool)
          && (!changed.hasAny(['notificationsDisabledForCancelledRide']) || request.resource.data.notificationsDisabledForCancelledRide is bool)
          && (!changed.hasAny(['notificationsDisabledForPendingUser']) || request.resource.data.notificationsDisabledForPendingUser is bool)
          && (!changed.hasAny(['notificationsDisabledForBoardPost']) || request.resource.data.notificationsDisabledForBoardPost is bool);
      }

      function validUserUpdateSelf() {
        let safeKeys = [
          'displayName','firstName','lastName','nickname','membershipCard',
          // l’utente può modificare i propri flag di notifica
          'notificationsDisabled',
          'notificationsDisabledForCreatedRide',
          'notificationsDisabledForCancelledRide',
          'notificationsDisabledForPendingUser',
          'notificationsDisabledForBoardPost'
        ];
        let diff = request.resource.data.diff(resource.data);
        let changed = diff.changedKeys();

        return changed.hasOnly(safeKeys)
          && (request.resource.data.displayName is string || request.resource.data.displayName == null)
          && (request.resource.data.firstName is string || request.resource.data.firstName == null)
          && (request.resource.data.lastName is string || request.resource.data.lastName == null)
          && (request.resource.data.nickname is string || request.resource.data.nickname == null)
          && (!changed.hasAny(['membershipCard']) || isValidMembershipCard(request.resource.data.membershipCard))
          // se l’utente cambia questi campi, devono essere booleani
          && (!changed.hasAny(['notificationsDisabled']) || request.resource.data.notificationsDisabled is bool)
          && (!changed.hasAny(['notificationsDisabledForCreatedRide']) || request.resource.data.notificationsDisabledForCreatedRide is bool)
          && (!changed.hasAny(['notificationsDisabledForCancelledRide']) || request.resource.data.notificationsDisabledForCancelledRide is bool)
          && (!changed.hasAny(['notificationsDisabledForPendingUser']) || request.resource.data.notificationsDisabledForPendingUser is bool)
          && (!changed.hasAny(['notificationsDisabledForBoardPost']) || request.resource.data.notificationsDisabledForBoardPost is bool);
      }

      function validUserDelete() {
        return resource.data.uid == uid
          && request.auth.uid != uid
          && !roleMatches(resource.data.role, '(?i)^owner$')
          && (
            (resource.data.keys().hasAny(['disabled']) && resource.data.disabled == true) ||
            (resource.data.keys().hasAny(['selfDeleted']) && resource.data.selfDeleted == true)
          );
      }

      function certificateAllowedKeys() {
        return [
          'type','expiresAt','alertDays','imageBase64','mimeType',
          'size','width','height','rotation','snoozedUntil','updatedAt','uploadedAt'
        ];
      }

      function validCertificateFields(data) {
        return data.keys().hasOnly(certificateAllowedKeys())
          && data.keys().hasAll(['type','expiresAt','alertDays','imageBase64','mimeType','size','updatedAt','uploadedAt'])
          && data.type is string && (data.type == 'semplice' || data.type == 'agonistico')
          && data.expiresAt is timestamp
          && data.alertDays is int && data.alertDays >= 1 && data.alertDays <= 365
          && data.imageBase64 is string && data.imageBase64.size() > 0 && data.imageBase64.size() <= 1500000
          && data.mimeType is string && (data.mimeType == 'image/jpeg' || data.mimeType == 'image/png')
          && data.size is int && data.size > 0 && data.size <= 1048576
          && (!data.keys().hasAny(['width']) || data.width == null || (data.width is int && data.width >= 0 && data.width <= 6000))
          && (!data.keys().hasAny(['height']) || data.height == null || (data.height is int && data.height >= 0 && data.height <= 6000))
          && (!data.keys().hasAny(['rotation']) || data.rotation == null || (data.rotation is int && data.rotation >= 0 && data.rotation < 360 && data.rotation % 90 == 0))
          && (!data.keys().hasAny(['snoozedUntil']) || data.snoozedUntil == null || data.snoozedUntil is timestamp)
          && data.updatedAt is timestamp
          && data.uploadedAt is timestamp;
      }

      function validCertificateCreate() {
        let data = request.resource.data;
        return validCertificateFields(data)
          && data.updatedAt == request.time
          && data.uploadedAt == request.time
          && (!data.keys().hasAny(['rotation']) || data.rotation == null || data.rotation == 0)
          && (!data.keys().hasAny(['snoozedUntil']) || data.snoozedUntil == null);
      }

      function validCertificateUpdate() {
        let diff = request.resource.data.diff(resource.data);
        let changed = diff.changedKeys();
        let added   = diff.addedKeys();
        let removed = diff.removedKeys();

        return changed.union(added).union(removed).hasOnly(certificateAllowedKeys())
          && removed.size() == 0
          && added.hasOnly(['rotation','snoozedUntil'])
          && !changed.hasAny(['imageBase64','mimeType','size','width','height','uploadedAt'])
          && validCertificateFields(request.resource.data)
          && request.resource.data.updatedAt == request.time;
      }

      match /medicalCertificate/{docId} {
        allow get: if isSelfOrOwner(uid) && docId == "metadata";
        allow list: if false;
        allow create: if isAuthed() && request.auth.uid == uid && docId == "metadata" && validCertificateCreate();
        allow update: if isAuthed() && request.auth.uid == uid && docId == "metadata" && validCertificateUpdate();
        allow delete: if isAuthed() && request.auth.uid == uid && docId == "metadata";
      }
    }

    // -----------------------
    // /users/{uid}/devices/{deviceId}
    // -----------------------
    match /users/{uid}/devices/{deviceId} {
      allow read: if isAuthed() && (request.auth.uid == uid || isOwner());
      allow create, update: if isAuthed() && request.auth.uid == uid && validDeviceUpsert();
      allow delete: if isAuthed() && request.auth.uid == uid;

      function deviceAllowedKeys() { return ['expoPushToken','platform','updatedAt']; }
      function validDeviceUpsert() {
        return request.resource.data.keys().hasOnly(deviceAllowedKeys())
          && (request.resource.data.expoPushToken is string
              && request.resource.data.expoPushToken.size() > 0
              && request.resource.data.expoPushToken.size() <= 255)
          && (request.resource.data.platform == 'ios' || request.resource.data.platform == 'android')
          && (request.resource.data.updatedAt is timestamp);
      }
    }

    // -----------------------
    // /users_public/{uid}
    // -----------------------
    match /users_public/{uid} {
      allow read: if true;

      allow create: if isAuthed()
        && (request.auth.uid == uid || isOwner())
        && validPublicCreate();

      allow update: if isAuthed()
        && (request.auth.uid == uid || isOwner())
        && validPublicUpdate();

      function publicAllowedKeys() {
        return [
          'displayName','firstName','lastName','nickname','createdAt',
          'email','role','approved','disabled'
        ];
      }

      function validPublicCreate() {
        return request.resource.data.keys().hasOnly(publicAllowedKeys())
          && (request.resource.data.displayName == null || (request.resource.data.displayName is string && request.resource.data.displayName.size() <= 120))
          && (request.resource.data.firstName == null || (request.resource.data.firstName is string && request.resource.data.firstName.size() <= 80))
          && (request.resource.data.lastName == null || (request.resource.data.lastName is string && request.resource.data.lastName.size() <= 80))
          && (request.resource.data.nickname == null || (request.resource.data.nickname is string && request.resource.data.nickname.size() <= 80))
          && (request.resource.data.createdAt is timestamp)
          && (!has('email') || request.resource.data.email == null || request.resource.data.email is string)
          && (!has('role') || roleIsOneOf(request.resource.data.role))
          && (!has('approved') || request.resource.data.approved is bool)
          && (!has('disabled') || request.resource.data.disabled is bool);
      }

      function validPublicUpdate() {
        return request.resource.data.keys().hasOnly(publicAllowedKeys())
          && (request.resource.data.displayName == null || (request.resource.data.displayName is string && request.resource.data.displayName.size() <= 120))
          && (request.resource.data.firstName == null || (request.resource.data.firstName is string && request.resource.data.firstName.size() <= 80))
          && (request.resource.data.lastName == null || (request.resource.data.lastName is string && request.resource.data.lastName.size() <= 80))
          && (request.resource.data.nickname == null || (request.resource.data.nickname is string && request.resource.data.nickname.size() <= 80))
          && (!has('createdAt') || request.resource.data.createdAt is timestamp)
          && (!has('email') || request.resource.data.email == null || request.resource.data.email is string)
          && (!has('role') || roleIsOneOf(request.resource.data.role))
          && (!has('approved') || request.resource.data.approved is bool)
          && (!has('disabled') || request.resource.data.disabled is bool);
      }
    }

    // -----------------------
    // /boardPosts/{postId}
    // -----------------------
    match /boardPosts/{postId} {
      function boardAllowedKeys() {
        return [
          'title','description','createdAt','createdBy','archived','archivedAt',
          'imageUrl','imageStoragePath','imageBase64',
          'updatedAt','updatedBy'
        ];
      }

      function nonEmptyString(val, maxLen) {
        return val is string && val.size() > 0 && val.size() <= maxLen;
      }

      function stringOrNull(val, maxLen) {
        return val == null || (val is string && val.size() <= maxLen);
      }

      function timestampOrServer(val) {
        return val is timestamp || val == request.time;
      }

      function boardHasAnyContent(data) {
        let hasTitle = data.keys().hasAny(['title']) && nonEmptyString(data.title, 160);
        let hasDescription = data.keys().hasAny(['description']) && nonEmptyString(data.description, 3000);
        let hasImageUrl = data.keys().hasAny(['imageUrl']) && data.imageUrl is string && data.imageUrl.size() > 0;
        let hasImageBase64 = data.keys().hasAny(['imageBase64']) && data.imageBase64 is string && data.imageBase64.size() > 0;
        return hasTitle || hasDescription || hasImageUrl || hasImageBase64;
      }

      function validBoardPayload(data) {
        return data.keys().hasOnly(boardAllowedKeys())
          && (!data.keys().hasAny(['title']) || nonEmptyString(data.title, 160))
          && (!data.keys().hasAny(['description']) || nonEmptyString(data.description, 3000))
          && (!data.keys().hasAny(['createdAt']) || timestampOrServer(data.createdAt))
          && (!data.keys().hasAny(['createdBy']) || stringOrNull(data.createdBy, 200))
          && (!data.keys().hasAny(['updatedAt']) || timestampOrServer(data.updatedAt))
          && (!data.keys().hasAny(['updatedBy']) || stringOrNull(data.updatedBy, 200))
          && (!data.keys().hasAny(['archived']) || data.archived is bool)
          && (!data.keys().hasAny(['archivedAt']) || timestampOrServer(data.archivedAt))
          && (!data.keys().hasAny(['imageUrl']) || data.imageUrl == null || (data.imageUrl is string && data.imageUrl.size() > 0 && data.imageUrl.size() <= 2048))
          && (!data.keys().hasAny(['imageStoragePath']) || data.imageStoragePath == null || (data.imageStoragePath is string && data.imageStoragePath.size() > 0 && data.imageStoragePath.size() <= 1024))
          && (!data.keys().hasAny(['imageBase64']) || data.imageBase64 == null
             || (data.imageBase64 is string && data.imageBase64.size() > 0 && data.imageBase64.size() <= 1048576))
          && boardHasAnyContent(data);
      }

      function validBoardCreate() {
        let data = request.resource.data;
        return validBoardPayload(data)
          && data.keys().hasAll(['createdAt','createdBy','archived'])
          && timestampOrServer(data.createdAt)
          && data.createdBy is string && data.createdBy.size() > 0 && data.createdBy.size() <= 200
          && data.archived is bool;
      }

      function validBoardUpdate() {
        return validBoardPayload(request.resource.data);
      }

      allow read: if canReadRides();

      allow create: if (isAdmin() || isOwner()) && validBoardCreate();
      allow update: if (isAdmin() || isOwner()) && validBoardUpdate();
      allow delete: if isAdmin() || isOwner();
    }

    // -----------------------
    // /rides/{rideId}
    // -----------------------
    match /rides/{rideId} {
      allow read: if canReadRides();

      allow create: if (isAdmin() || isOwner()) && validRideCreateFlexible();
      allow update: if (isAdmin() || isOwner()) && validRideUpdatePartial();
      allow delete: if (isAdmin() || isOwner());


      // -------- participants subcollection --------

      // -------- participants subcollection --------
      match /participants/{uid} {
        allow read: if canReadRides();

        allow create: if
          canReadRides()
          && request.auth.uid == uid
          && parentRideIsBookable()
          && validParticipantCreate();

        allow update: if
          canReadRides()
          && (request.auth.uid == uid || isAdmin() || isOwner())
          && parentRideIsBookable()
          && validParticipantUpdatePartial();

        allow delete: if
          canReadRides()
          && parentRideIsBookable()
          && (
            request.auth.uid == uid
            || isAdmin()
            || isOwner()
          );

        function parentRideIsBookable() {
          let ride = get(/databases/$(database)/documents/rides/$(rideId)).data;
          return !(ride.status == 'cancelled') && !(ride.archived == true);
        }

        function validParticipantCreate() {
          let allowed = ['uid','name','displayName','nickname','note','createdAt','services'];
          return request.resource.data.keys().hasOnly(allowed)
            && request.resource.data.uid == uid
            && (
              !has('name')
              || request.resource.data.name == null
              || (
                request.resource.data.name is string
                && request.resource.data.name.size() > 0
                && request.resource.data.name.size() <= 120
              )
            )
            && (!has('displayName') || request.resource.data.displayName == null || (request.resource.data.displayName is string && request.resource.data.displayName.size() > 0 && request.resource.data.displayName.size() <= 120))
            && (!has('nickname') || request.resource.data.nickname == null || (request.resource.data.nickname is string && request.resource.data.nickname.size() > 0 && request.resource.data.nickname.size() <= 120))
            && (request.resource.data.note == null || (request.resource.data.note is string && request.resource.data.note.size() <= 500))
            && (request.resource.data.createdAt is timestamp || request.resource.data.createdAt == request.time)
            && (!has('services') || validServiceResponses(request.resource.data.services));
        }

        function validParticipantUpdatePartial() {
          let diff = request.resource.data.diff(resource.data);
          let changed = diff.changedKeys();
          let added   = diff.addedKeys();
          let removed = diff.removedKeys();

          let allowed = ['note','services'];

          return changed.union(added).union(removed).hasOnly(allowed)
            && (!(changed.hasAny(['note']) || added.hasAny(['note'])) || (request.resource.data.note == null || (request.resource.data.note is string && request.resource.data.note.size() <= 500)))
            && (!(changed.hasAny(['services']) || added.hasAny(['services'])) || validServiceResponses(request.resource.data.services));
        }
      }
    }

    // -----------------------
    // /treks/{trekId}
    // -----------------------
    match /treks/{trekId} {
      allow read: if canReadRides();

      allow create: if (isAdmin() || isOwner()) && validRideCreateFlexible(); // Reusing Ride validation for now as they are identical structure-wise
      allow update: if (isAdmin() || isOwner()) && validRideUpdatePartial();
      allow delete: if (isAdmin() || isOwner());

      // -------- participants subcollection --------
      match /participants/{uid} {
        allow read: if canReadRides();

        allow create: if
          canReadRides()
          && request.auth.uid == uid
          && parentTrekIsBookable()
          && validParticipantCreate();

        allow update: if
          canReadRides()
          && (request.auth.uid == uid || isAdmin() || isOwner())
          && parentTrekIsBookable()
          && validParticipantUpdatePartial();

        allow delete: if
          canReadRides()
          && parentTrekIsBookable()
          && (
            request.auth.uid == uid
            || isAdmin()
            || isOwner()
          );

        function parentTrekIsBookable() {
          let trek = get(/databases/$(database)/documents/treks/$(trekId)).data;
          return !(trek.status == 'cancelled') && !(trek.archived == true);
        }

        // Reusing same validator functions from Rides scope if possible? 
        // No, functions are scoped to the match block usually unless defined globally or in parent.
        // The validator functions are defined inside match /rides/{rideId} scope in original file.
        // I need to duplicate them or move them up. 
        // Moving them up is cleaner but risky for regression.
        // I will duplicate strict validators for safety.
        
        function validParticipantCreate() {
          let allowed = ['uid','name','displayName','nickname','note','createdAt','services'];
          return request.resource.data.keys().hasOnly(allowed)
            && request.resource.data.uid == uid
            && (
              !has('name')
              || request.resource.data.name == null
              || (
                request.resource.data.name is string
                && request.resource.data.name.size() > 0
                && request.resource.data.name.size() <= 120
              )
            )
            && (!has('displayName') || request.resource.data.displayName == null || (request.resource.data.displayName is string && request.resource.data.displayName.size() > 0 && request.resource.data.displayName.size() <= 120))
            && (!has('nickname') || request.resource.data.nickname == null || (request.resource.data.nickname is string && request.resource.data.nickname.size() > 0 && request.resource.data.nickname.size() <= 120))
            && (request.resource.data.note == null || (request.resource.data.note is string && request.resource.data.note.size() <= 500))
            && (request.resource.data.createdAt is timestamp || request.resource.data.createdAt == request.time)
            && (!has('services') || validServiceResponses(request.resource.data.services));
        }

        function validServiceResponses(val) {
           return val == null ||
          (
            val is map &&
            val.keys().hasOnly(['lunch','dinner','overnight']) &&
            (!val.keys().hasAny(['lunch']) || val.lunch == null || (val.lunch == 'yes' || val.lunch == 'no')) &&
            (!val.keys().hasAny(['dinner']) || val.dinner == null || (val.dinner == 'yes' || val.dinner == 'no')) &&
            (!val.keys().hasAny(['overnight']) || val.overnight == null || (val.overnight == 'yes' || val.overnight == 'no'))
          );
        }

        function validParticipantUpdatePartial() {
          let diff = request.resource.data.diff(resource.data);
          let changed = diff.changedKeys();
          let added   = diff.addedKeys();
          let removed = diff.removedKeys();

          let allowed = ['note','services'];

          return changed.union(added).union(removed).hasOnly(allowed)
            && (!(changed.hasAny(['note']) || added.hasAny(['note'])) || (request.resource.data.note == null || (request.resource.data.note is string && request.resource.data.note.size() <= 500)))
            && (!(changed.hasAny(['services']) || added.hasAny(['services'])) || validServiceResponses(request.resource.data.services));
        }
      }
    }

    // -----------------------
    // /analyticsEvents/{eventId}
    // -----------------------
    match /app_content/informazioni {
      allow read: if isAuthed();
      allow create: if isOwner() && validInfoCreate();
      allow update: if isOwner() && validInfoUpdate();

      function infoAllowedKeys() {
        return ['items','updatedAt','updatedBy'];
      }

      function validInfoItem(item) {
        return item is map
          && item.keys().hasOnly(['id','label','value','type','section'])
          && item.id is string && item.id.size() > 0 && item.id.size() <= 40
          && item.label is string && item.label.size() > 0 && item.label.size() <= 160
          && item.value is string && item.value.size() > 0 && item.value.size() <= 600
          && (item.type in ['text','phone','whatsapp','email','iban','address','vat'])
          && (item.section in ['Associazione','Contatti','Dati Fiscali']);
      }

      function validInfoItems(items) {
        return items is list
          && items.size() > 0
          && items.size() <= 20
          && validInfoItem(items[0])
          && (items.size() < 2 || validInfoItem(items[1]))
          && (items.size() < 3 || validInfoItem(items[2]))
          && (items.size() < 4 || validInfoItem(items[3]))
          && (items.size() < 5 || validInfoItem(items[4]))
          && (items.size() < 6 || validInfoItem(items[5]))
          && (items.size() < 7 || validInfoItem(items[6]))
          && (items.size() < 8 || validInfoItem(items[7]))
          && (items.size() < 9 || validInfoItem(items[8]))
          && (items.size() < 10 || validInfoItem(items[9]))
          && (items.size() < 11 || validInfoItem(items[10]))
          && (items.size() < 12 || validInfoItem(items[11]))
          && (items.size() < 13 || validInfoItem(items[12]))
          && (items.size() < 14 || validInfoItem(items[13]))
          && (items.size() < 15 || validInfoItem(items[14]))
          && (items.size() < 16 || validInfoItem(items[15]))
          && (items.size() < 17 || validInfoItem(items[16]))
          && (items.size() < 18 || validInfoItem(items[17]))
          && (items.size() < 19 || validInfoItem(items[18]))
          && (items.size() < 20 || validInfoItem(items[19]));
      }

      function validInfoCreate() {
        return request.resource.data.keys().hasOnly(infoAllowedKeys())
          && request.resource.data.keys().hasAll(['items'])
          && validInfoItems(request.resource.data.items)
          && (!request.resource.data.keys().hasAny(['updatedAt']) || request.resource.data.updatedAt is timestamp || request.resource.data.updatedAt == request.time)
          && (!request.resource.data.keys().hasAny(['updatedBy']) || request.resource.data.updatedBy == null || request.resource.data.updatedBy is string);
      }

      function validInfoUpdate() {
        let diff = request.resource.data.diff(resource.data);
        let changed = diff.changedKeys();
        let added   = diff.addedKeys();
        let removed = diff.removedKeys();
        return changed.union(added).union(removed).hasOnly(infoAllowedKeys())
          && !removed.hasAny(['items'])
          && (!changed.hasAny(['items']) && !added.hasAny(['items']) || validInfoItems(request.resource.data.items))
          && (!changed.hasAny(['updatedAt']) && !added.hasAny(['updatedAt']) || request.resource.data.updatedAt is timestamp || request.resource.data.updatedAt == request.time)
          && (!changed.hasAny(['updatedBy']) && !added.hasAny(['updatedBy']) || request.resource.data.updatedBy == null || request.resource.data.updatedBy is string);
      }
    }

    // -----------------------
    // /analyticsEvents/{eventId}
    // -----------------------
    match /social_events/{eventId} {
      allow read: if canReadRides();
      allow create: if (isAdmin() || isOwner()) && validSocialCreate();
      allow update: if (isAdmin() || isOwner()) && validSocialUpdate();
      allow delete: if (isAdmin() || isOwner());

      function socialAllowedKeys() {
        return [
          'title','meetingPlaceText','meetingMapUrl','organizerName','description',
          'startAt','status',
          'createdAt','createdBy','updatedAt','updatedBy',
          'cancelledAt','cancelledBy','archivedAt',
          'participantsCount',
          'extraServices','extras'
        ];
      }

      function nonEmptyString(val, maxLen) {
        return val is string && val.size() > 0 && val.size() <= maxLen;
      }

      function stringOrNull(val, maxLen) {
        return val == null || (val is string && val.size() <= maxLen);
      }

      function timestampOrServer(val) {
        return val is timestamp || val == request.time;
      }

      function validSocialPayload(data) {
        return (!data.keys().hasAny(['title']) || nonEmptyString(data.title, 160))
          && (!data.keys().hasAny(['meetingPlaceText']) || nonEmptyString(data.meetingPlaceText, 200))
          && (!data.keys().hasAny(['meetingMapUrl']) || data.meetingMapUrl == null || (data.meetingMapUrl is string && data.meetingMapUrl.size() > 0 && data.meetingMapUrl.size() <= 2048))
          && (!data.keys().hasAny(['organizerName']) || data.organizerName == null || (data.organizerName is string && data.organizerName.size() <= 120))
          && (!data.keys().hasAny(['description']) || data.description == null || (data.description is string && data.description.size() <= 4000))
          && (!data.keys().hasAny(['startAt']) || data.startAt is timestamp)
          && (!data.keys().hasAny(['status']) || (data.status in ['active','cancelled','archived']))
          && (!data.keys().hasAny(['createdAt']) || timestampOrServer(data.createdAt))
          && (!data.keys().hasAny(['updatedAt']) || timestampOrServer(data.updatedAt))
          && (!data.keys().hasAny(['createdBy']) || stringOrNull(data.createdBy, 200))
          && (!data.keys().hasAny(['updatedBy']) || stringOrNull(data.updatedBy, 200))
          && (!data.keys().hasAny(['cancelledAt']) || timestampOrServer(data.cancelledAt))
          && (!data.keys().hasAny(['cancelledBy']) || stringOrNull(data.cancelledBy, 200))
          && (!data.keys().hasAny(['archivedAt']) || timestampOrServer(data.archivedAt))
          && (!data.keys().hasAny(['participantsCount']) || (data.participantsCount is int && data.participantsCount >= 0))
          && (!data.keys().hasAny(['extraServices']) || validSocialExtraServices(data.extraServices))
          && (!data.keys().hasAny(['extras']) || (
            data.extras is map
            && (!data.extras.keys().hasAny(['lunch']) || data.extras.lunch is bool)
            && (!data.extras.keys().hasAny(['dinner']) || data.extras.dinner is bool)
          ));
      }

      function validSocialCreate() {
        let data = request.resource.data;
        return validSocialPayload(data)
          && data.keys().hasOnly(socialAllowedKeys())
          && data.keys().hasAll(['title','meetingPlaceText','startAt','status','createdAt','createdBy'])
          && data.createdBy is string && data.createdBy.size() > 0 && data.createdBy.size() <= 200
          && (data.createdAt is timestamp || data.createdAt == request.time);
      }

      function validSocialUpdate() {
        let diff = request.resource.data.diff(resource.data);
        let changed = diff.changedKeys();
        let added   = diff.addedKeys();
        let removed = diff.removedKeys();
        return changed.union(added).union(removed).hasOnly(socialAllowedKeys())
          && validSocialPayload(request.resource.data);
      }

      function validSocialExtraServices(val) {
        return val == null ||
          (
            val is map &&
            val.keys().hasOnly(['lunch','dinner']) &&
            (!val.keys().hasAny(['lunch']) || validSocialExtraNode(val.lunch)) &&
            (!val.keys().hasAny(['dinner']) || validSocialExtraNode(val.dinner))
          );
      }

      function validSocialExtraNode(node) {
        return node == null ||
          (
            node is map &&
            node.keys().hasOnly(['enabled','label']) &&
            node.enabled is bool &&
            (!node.keys().hasAny(['label']) || node.label == null || (node.label is string && node.label.size() <= 120))
          );
      }

      match /participants/{uid} {
        allow read: if isActiveUser();
        allow create: if isActiveUser() && socialEventIsEditable(eventId) && (isAdmin() || isOwner() || isSelfSocialParticipant(uid)) && validSocialParticipantCreate(uid);
        allow update: if isActiveUser() && socialEventIsEditable(eventId) && (isAdmin() || isOwner() || isSelfSocialParticipant(uid)) && validSocialParticipantUpdate(uid);
        allow delete: if isActiveUser() && socialEventIsEditable(eventId) && (isAdmin() || isOwner() || isSelfSocialParticipant(uid));

        function socialEventIsEditable(id) {
          let ev = get(/databases/$(database)/documents/social_events/$(id)).data;
          return ev.status != "cancelled" && ev.status != "archived";
        }

        function isSelfSocialParticipant(pid) {
          return request.auth != null &&
            (
              pid == request.auth.uid
              || (resource != null && resource.data.uid == request.auth.uid)
              || (request.resource != null && request.resource.data.uid == request.auth.uid)
            );
        }

        function validSocialParticipantCreate(targetUid) {
          let data = request.resource.data;
          let allowed = ['uid','displayName','name','note','services','extrasChoice','joinedAt','createdAt','source'];
          return data.keys().hasOnly(allowed)
            && (data.uid is string && data.uid == targetUid)
            && (!data.keys().hasAny(['displayName']) || data.displayName == null || (data.displayName is string && data.displayName.size() <= 120))
            && (!data.keys().hasAny(['name']) || data.name == null || (data.name is string && data.name.size() <= 120))
            && (!data.keys().hasAny(['note']) || (data.note == null || (data.note is string && data.note.size() <= 500)))
            && (!data.keys().hasAny(['services']) || validSocialServiceResponses(data.services))
            && (!data.keys().hasAny(['extrasChoice']) || (
              data.extrasChoice is map
              && (!data.extrasChoice.keys().hasAny(['lunch']) || (data.extrasChoice.lunch in ['yes','no']))
              && (!data.extrasChoice.keys().hasAny(['dinner']) || (data.extrasChoice.dinner in ['yes','no']))
            ))
            && (!data.keys().hasAny(['joinedAt']) || data.joinedAt is timestamp || data.joinedAt == request.time)
            && (!data.keys().hasAny(['createdAt']) || data.createdAt is timestamp || data.createdAt == request.time)
            && (!data.keys().hasAny(['source']) || data.source == null || (data.source is string && data.source.size() <= 40));
        }

        function validSocialParticipantUpdate(targetUid) {
          let diff = request.resource.data.diff(resource.data);
          let changed = diff.changedKeys();
          let added   = diff.addedKeys();
          let removed = diff.removedKeys();
          let allowed = ['note','services'];

          return changed.union(added).union(removed).hasOnly(allowed)
            && request.resource.data.uid == resource.data.uid
            && (!changed.hasAny(['note']) && !added.hasAny(['note']) || (request.resource.data.note == null || (request.resource.data.note is string && request.resource.data.note.size() <= 500)))
            && (!changed.hasAny(['services']) && !added.hasAny(['services']) || validSocialServiceResponses(request.resource.data.services));
        }

        function validSocialServiceResponses(val) {
          return val == null ||
            (
              val is map &&
              val.keys().hasOnly(['lunch','dinner']) &&
              (!val.keys().hasAny(['lunch']) || (val.lunch in ['yes','no'])) &&
              (!val.keys().hasAny(['dinner']) || (val.dinner in ['yes','no']))
            );
        }
      }
    }

    // -----------------------
    // /analyticsEvents/{eventId}
    // -----------------------
    match /analyticsEvents/{eventId} {
      allow read: if isOwner();
      allow create: if isAuthed() && validAnalyticsCreate();
      allow update, delete: if false;

      function validAnalyticsCreate() {
        return request.resource.data.keys().hasOnly(['name','payload','uid','createdAt'])
          && request.resource.data.name is string
          && request.resource.data.name.size() > 0
          && request.resource.data.name.size() <= 200
          && (!has('payload') || request.resource.data.payload == null || request.resource.data.payload is map)
          && (!has('uid') || request.resource.data.uid == null || (request.resource.data.uid is string && request.resource.data.uid.size() > 0 && request.resource.data.uid.size() <= 128))
          && (request.resource.data.createdAt is timestamp || request.resource.data.createdAt == request.time)
          && request.resource.data.createdAt == request.time;
      }
    }

    // -----------------------
    // /notifications/{notificationId}
    // -----------------------
    match /notifications/{notificationId} {
      allow read: if false;
      allow create: if (isAdmin() || isOwner()) && validNotificationCreate();
      allow update, delete: if false;

      function notificationAllowedKeys() {
        return ['type','rideId','title','createdAt','read','target'];
      }

      function validNotificationCreate() {
        return request.resource.data.keys().hasOnly(notificationAllowedKeys())
          && request.resource.data.type is string
          && request.resource.data.type.size() > 0
          && request.resource.data.type.size() <= 80
          && (!has('rideId') || (request.resource.data.rideId is string && request.resource.data.rideId.size() > 0 && request.resource.data.rideId.size() <= 80))
          && (!has('title') || (request.resource.data.title is string && request.resource.data.title.size() > 0 && request.resource.data.title.size() <= 200))
          && request.resource.data.createdAt is timestamp
          && (request.resource.data.read is bool)
          && (!has('target') || (request.resource.data.target is string && request.resource.data.target.size() > 0 && request.resource.data.target.size() <= 80));
      }
    }

  }
}
